<template>
  <div class="max-w-7xl mx-auto py-6 px-4">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav class="mb-4 text-sm">
      <ol class="flex items-center space-x-2 text-gray-500">
        <li>
          <NuxtLink to="/admin/dashboard" class="hover:text-blue-600"
            >ç®¡ç†åå°</NuxtLink
          >
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </li>
        <li>
          <NuxtLink to="/admin/competitions" class="hover:text-blue-600"
            >æ¯”èµ›ç®¡ç†</NuxtLink
          >
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </li>
        <li class="text-gray-900">CDK ç®¡ç†</li>
      </ol>
    </nav>

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">CDK ç®¡ç†</h1>
        <p v-if="competition" class="mt-1 text-gray-600">æ¯”èµ›ï¼š{{ competition.title }}</p>
      </div>
      <NuxtLink
        to="/admin/competitions"
        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-md font-medium"
      >
        è¿”å›æ¯”èµ›åˆ—è¡¨
      </NuxtLink>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div v-if="data?.stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">å¯ç”¨</p>
            <p class="text-2xl font-semibold text-gray-900">{{ data.stats.available }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">å·²é¢†å–</p>
            <p class="text-2xl font-semibold text-gray-900">{{ data.stats.claimed }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
              <svg
                class="w-5 h-5 text-red-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">ä½œåºŸ</p>
            <p class="text-2xl font-semibold text-gray-900">{{ data.stats.void }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-gray-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                ></path>
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">æ€»æ•°</p>
            <p class="text-2xl font-semibold text-gray-900">{{ data.stats.total }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥åŒºåŸŸ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">æ‰¹é‡å¯¼å…¥ CDK</h3>
      <form @submit.prevent="importCdks">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
          <div class="lg:col-span-2">
            <label for="cdk-codes" class="block text-sm font-medium text-gray-700 mb-1">
              CDK ä»£ç  *
            </label>
            <textarea
              id="cdk-codes"
              v-model="importForm.codes"
              rows="4"
              required
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="æ¯è¡Œä¸€ä¸ªCDKä»£ç ï¼Œä¾‹å¦‚ï¼š&#10;ABCD1234&#10;EFGH5678&#10;IJKL9012"
            ></textarea>
            <p class="mt-1 text-sm text-gray-500">
              æ¯è¡Œè¾“å…¥ä¸€ä¸ªCDKä»£ç ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å»é™¤é‡å¤å’Œç©ºè¡Œ
            </p>
          </div>
          <div class="space-y-4">
            <div>
              <label for="batch-id" class="block text-sm font-medium text-gray-700 mb-1">
                æ‰¹æ¬¡ID
              </label>
              <input
                id="batch-id"
                v-model="importForm.batchId"
                type="text"
                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="ä¾‹å¦‚ï¼šbatch-001"
              />
              <p class="mt-1 text-sm text-gray-500">ç”¨äºæ‰¹é‡ç®¡ç†ï¼Œä¸å¡«å†™åˆ™è‡ªåŠ¨ç”Ÿæˆ</p>
            </div>
            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                å¤‡æ³¨
              </label>
              <input
                id="notes"
                v-model="importForm.notes"
                type="text"
                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="å¤‡æ³¨ä¿¡æ¯"
              />
            </div>
            <button
              type="submit"
              :disabled="isImporting || !importForm.codes.trim()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium disabled:opacity-50"
            >
              {{ isImporting ? "å¯¼å…¥ä¸­..." : "å¯¼å…¥ CDK" }}
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- ç­›é€‰å’Œæœç´¢ -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex flex-wrap gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€ç­›é€‰</label>
          <select
            v-model="selectedStatus"
            @change="fetchCdks"
            class="border border-gray-300 rounded-md px-3 py-2 text-sm"
          >
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="AVAILABLE">å¯ç”¨</option>
            <option value="CLAIMED">å·²é¢†å–</option>
            <option value="VOID">ä½œåºŸ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ‰¹æ¬¡ç­›é€‰</label>
          <select
            v-model="selectedBatch"
            @change="fetchCdks"
            class="border border-gray-300 rounded-md px-3 py-2 text-sm"
          >
            <option value="">å…¨éƒ¨æ‰¹æ¬¡</option>
            <option v-for="batch in data?.batches" :key="batch.id" :value="batch.id">
              {{ batch.id }} ({{ formatDate(batch.createdAt) }})
            </option>
          </select>
        </div>
        <div class="flex-1 min-w-48">
          <label class="block text-sm font-medium text-gray-700 mb-1">æœç´¢CDK</label>
          <input
            v-model="searchQuery"
            @input="debounceSearch"
            type="text"
            placeholder="è¾“å…¥CDKä»£ç æœç´¢..."
            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
        <div class="flex items-end">
          <button
            @click="refresh"
            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium"
          >
            åˆ·æ–°
          </button>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œ -->
    <div
      v-if="selectedCdks.length > 0"
      class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6"
    >
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <svg
            class="w-5 h-5 text-yellow-400 mr-2"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <span class="text-sm font-medium text-yellow-800">
            å·²é€‰æ‹© {{ selectedCdks.length }} ä¸ªCDK
          </span>
        </div>
        <div class="flex space-x-2">
          <button
            @click="bulkVoidCdks"
            :disabled="isBulkOperating"
            class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50"
          >
            {{ isBulkOperating ? "å¤„ç†ä¸­..." : "æ‰¹é‡ä½œåºŸ" }}
          </button>
          <button
            @click="bulkDeleteCdks"
            :disabled="isBulkOperating"
            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50"
          >
            {{ isBulkOperating ? "å¤„ç†ä¸­..." : "æ‰¹é‡åˆ é™¤" }}
          </button>
          <button
            @click="clearSelection"
            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-medium"
          >
            å–æ¶ˆé€‰æ‹©
          </button>
        </div>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="pending" class="text-center py-8">
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
      ></div>
      <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
    </div>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <div v-else-if="error" class="bg-red-50 border border-red-200 rounded-md p-4">
      <p class="text-red-800">åŠ è½½å¤±è´¥: {{ error.message }}</p>
    </div>

    <!-- CDK åˆ—è¡¨ -->
    <div v-else-if="data?.cdks" class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="px-4 py-5 sm:p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">CDK åˆ—è¡¨</h3>
          <div class="flex items-center space-x-2">
            <label class="flex items-center text-sm text-gray-600">
              <input
                type="checkbox"
                :checked="isAllSelected"
                @change="toggleSelectAll"
                class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 mr-2"
              />
              å…¨é€‰å½“å‰é¡µ
            </label>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  é€‰æ‹©
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  CDKä»£ç 
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  çŠ¶æ€
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  å…³è”å¯¹è±¡
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  æ‰¹æ¬¡
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  åˆ›å»ºæ—¶é—´
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="cdk in data.cdks" :key="cdk.id" class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <input
                    type="checkbox"
                    :value="cdk.id"
                    v-model="selectedCdks"
                    class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                  />
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <span class="text-sm font-mono text-gray-900">{{ cdk.code }}</span>
                    <button
                      @click="copyCdkCode(cdk.code)"
                      class="ml-2 text-gray-400 hover:text-gray-600"
                      title="å¤åˆ¶CDKä»£ç "
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                        ></path>
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    :class="{
                      'bg-green-100 text-green-800': cdk.status === 'AVAILABLE',
                      'bg-blue-100 text-blue-800': cdk.status === 'CLAIMED',
                      'bg-red-100 text-red-800': cdk.status === 'VOID',
                    }"
                    class="px-2 py-1 rounded-full text-xs font-medium"
                  >
                    {{ getStatusText(cdk.status) }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <div v-if="cdk.status === 'CLAIMED'">
                    <div v-if="cdk.team" class="text-blue-600">
                      å›¢é˜Ÿ: {{ cdk.team.name }}
                    </div>
                    <div v-if="cdk.user" class="text-green-600">
                      ç”¨æˆ·: {{ cdk.user.username }}
                    </div>
                    <div v-if="cdk.claimedByUser" class="text-gray-500 text-xs">
                      é¢†å–äºº: {{ cdk.claimedByUser.username }}
                    </div>
                  </div>
                  <span v-else class="text-gray-400">-</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ cdk.batchId || "-" }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ formatDate(cdk.createdAt) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex space-x-2">
                    <button
                      v-if="cdk.status === 'AVAILABLE'"
                      @click="voidCdk(cdk.id)"
                      class="text-orange-600 hover:text-orange-900"
                      title="ä½œåºŸCDK"
                    >
                      ä½œåºŸ
                    </button>
                    <button
                      @click="deleteCdk(cdk.id)"
                      class="text-red-600 hover:text-red-900"
                      title="åˆ é™¤CDK"
                    >
                      åˆ é™¤
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div v-else class="text-center py-12">
      <div class="text-gray-400 text-6xl mb-4">ğŸŸï¸</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— CDK</h3>
      <p class="text-gray-600 mb-6">å¼€å§‹å¯¼å…¥ä½ çš„ç¬¬ä¸€æ‰¹CDKå§ï¼</p>
    </div>

    <!-- åˆ†é¡µ -->
    <div
      v-if="data?.pagination && data.pagination.total > data.pagination.limit"
      class="mt-6"
    >
      <Pagination
        :current-page="data.pagination.page"
        :total-pages="data.pagination.totalPages"
        :total-items="data.pagination.total"
        :items-per-page="data.pagination.limit"
        @page-change="goToPage"
        @items-per-page-change="changeItemsPerPage"
      />
    </div>
  </div>
</template>

<script setup>
import Pagination from "~/components/common/Pagination.vue";

definePageMeta({
  middleware: "admin",
});

const route = useRoute();
const competitionId = route.params.id;

// è·å–æ¯”èµ›ä¿¡æ¯
const { data: competition } = await useFetch(`/api/admin/competitions/${competitionId}`);

// ç­›é€‰å’Œæœç´¢
const selectedStatus = ref("");
const selectedBatch = ref("");
const searchQuery = ref("");
const currentPage = ref(1);

// è·å–CDKåˆ—è¡¨
const { data, pending, error, refresh } = await useFetch(
  `/api/admin/competitions/${competitionId}/cdk`,
  {
    query: {
      status: selectedStatus,
      batchId: selectedBatch,
      search: searchQuery,
      page: currentPage,
      limit: 20,
    },
  }
);

// æ‰¹é‡å¯¼å…¥
const importForm = ref({
  codes: "",
  batchId: "",
  notes: "",
});
const isImporting = ref(false);

// æ‰¹é‡æ“ä½œ
const selectedCdks = ref([]);
const isBulkOperating = ref(false);

// æœç´¢é˜²æŠ–
let searchTimeout = null;
const debounceSearch = () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage.value = 1;
    refresh();
  }, 500);
};

const fetchCdks = () => {
  currentPage.value = 1;
  refresh();
};

const goToPage = (page) => {
  currentPage.value = page;
  refresh();
};

const changeItemsPerPage = (newItemsPerPage) => {
  data.value.pagination.limit = newItemsPerPage;
  currentPage.value = 1;
  refresh();
};

const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString("zh-CN");
};

const getStatusText = (status) => {
  const statusMap = {
    AVAILABLE: "å¯ç”¨",
    CLAIMED: "å·²é¢†å–",
    VOID: "ä½œåºŸ",
  };
  return statusMap[status] || status;
};

// å¤åˆ¶CDKä»£ç 
const copyCdkCode = async (code) => {
  try {
    await navigator.clipboard.writeText(code);
    push.success("CDKä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
  } catch (err) {
    console.error("å¤åˆ¶å¤±è´¥:", err);
    push.error("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
  }
};

// æ‰¹é‡å¯¼å…¥CDK
const importCdks = async () => {
  if (isImporting.value || !importForm.value.codes.trim()) return;

  isImporting.value = true;

  try {
    const codes = importForm.value.codes
      .split("\n")
      .map((code) => code.trim())
      .filter((code) => code.length > 0);

    if (codes.length === 0) {
      push.error("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªCDKä»£ç ");
      isImporting.value = false;
      return;
    }

    const response = await $fetch(`/api/admin/competitions/${competitionId}/cdk/import`, {
      method: "POST",
      body: {
        codes,
        batchId: importForm.value.batchId.trim() || undefined,
        notes: importForm.value.notes.trim() || undefined,
      },
    });

    if (response.success) {
      push.success(
        `æˆåŠŸå¯¼å…¥ ${response.imported.successful} ä¸ªCDKï¼Œè·³è¿‡ ${response.imported.duplicates} ä¸ªé‡å¤çš„CDK`
      );
      importForm.value.codes = "";
      importForm.value.batchId = "";
      importForm.value.notes = "";
      await refresh();
    } else {
      push.error("å¯¼å…¥CDKå¤±è´¥");
    }
  } catch (err) {
    console.error("å¯¼å…¥CDKæ—¶å‡ºé”™:", err);
    push.error("å¯¼å…¥CDKæ—¶å‡ºé”™: " + (err.data?.message || err.message || "æœªçŸ¥é”™è¯¯"));
  } finally {
    isImporting.value = false;
  }
};

// é€‰æ‹©ç›¸å…³
const isAllSelected = computed(() => {
  return (
    data.value?.cdks?.length > 0 && selectedCdks.value.length === data.value.cdks.length
  );
});

const toggleSelectAll = () => {
  if (isAllSelected.value) {
    selectedCdks.value = [];
  } else {
    selectedCdks.value = data.value?.cdks?.map((cdk) => cdk.id) || [];
  }
};

const clearSelection = () => {
  selectedCdks.value = [];
};

// å•ä¸ªæ“ä½œ
const voidCdk = async (cdkId) => {
  if (!confirm("ç¡®å®šè¦ä½œåºŸè¿™ä¸ªCDKå—ï¼Ÿ")) return;

  try {
    const response = await $fetch(
      `/api/admin/competitions/${competitionId}/cdk/bulk-void`,
      {
        method: "POST",
        body: { cdkIds: [cdkId] },
      }
    );

    if (response.success) {
      push.success("CDKä½œåºŸæˆåŠŸ");
      await refresh();
    } else {
      push.error("CDKä½œåºŸå¤±è´¥");
    }
  } catch (err) {
    console.error("ä½œåºŸCDKæ—¶å‡ºé”™:", err);
    push.error("ä½œåºŸCDKæ—¶å‡ºé”™: " + (err.data?.message || err.message || "æœªçŸ¥é”™è¯¯"));
  }
};

const deleteCdk = async (cdkId) => {
  if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªCDKå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;

  try {
    const response = await $fetch(
      `/api/admin/competitions/${competitionId}/cdk/bulk-delete`,
      {
        method: "DELETE",
        body: { cdkIds: [cdkId] },
      }
    );

    if (response.success) {
      push.success("CDKåˆ é™¤æˆåŠŸ");
      await refresh();
    } else {
      push.error("CDKåˆ é™¤å¤±è´¥");
    }
  } catch (err) {
    console.error("åˆ é™¤CDKæ—¶å‡ºé”™:", err);
    push.error("åˆ é™¤CDKæ—¶å‡ºé”™: " + (err.data?.message || err.message || "æœªçŸ¥é”™è¯¯"));
  }
};

// æ‰¹é‡æ“ä½œ
const bulkVoidCdks = async () => {
  if (selectedCdks.value.length === 0) return;
  if (!confirm(`ç¡®å®šè¦ä½œåºŸé€‰ä¸­çš„ ${selectedCdks.value.length} ä¸ªCDKå—ï¼Ÿ`)) return;

  isBulkOperating.value = true;

  try {
    const response = await $fetch(
      `/api/admin/competitions/${competitionId}/cdk/bulk-void`,
      {
        method: "POST",
        body: { cdkIds: selectedCdks.value },
      }
    );

    if (response.success) {
      push.success(`æˆåŠŸä½œåºŸ ${response.affected} ä¸ªCDK`);
      selectedCdks.value = [];
      await refresh();
    } else {
      push.error("æ‰¹é‡ä½œåºŸCDKå¤±è´¥");
    }
  } catch (err) {
    console.error("æ‰¹é‡ä½œåºŸCDKæ—¶å‡ºé”™:", err);
    push.error("æ‰¹é‡ä½œåºŸCDKæ—¶å‡ºé”™: " + (err.data?.message || err.message || "æœªçŸ¥é”™è¯¯"));
  } finally {
    isBulkOperating.value = false;
  }
};

const bulkDeleteCdks = async () => {
  if (selectedCdks.value.length === 0) return;
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCdks.value.length} ä¸ªCDKå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`))
    return;

  isBulkOperating.value = true;

  try {
    const response = await $fetch(
      `/api/admin/competitions/${competitionId}/cdk/bulk-delete`,
      {
        method: "DELETE",
        body: { cdkIds: selectedCdks.value },
      }
    );

    if (response.success) {
      push.success(`æˆåŠŸåˆ é™¤ ${response.affected} ä¸ªCDK`);
      selectedCdks.value = [];
      await refresh();
    } else {
      push.error("æ‰¹é‡åˆ é™¤CDKå¤±è´¥");
    }
  } catch (err) {
    console.error("æ‰¹é‡åˆ é™¤CDKæ—¶å‡ºé”™:", err);
    push.error("æ‰¹é‡åˆ é™¤CDKæ—¶å‡ºé”™: " + (err.data?.message || err.message || "æœªçŸ¥é”™è¯¯"));
  } finally {
    isBulkOperating.value = false;
  }
};
</script>

<style scoped>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
