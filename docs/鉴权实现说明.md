# 鉴权实现说明文档

## 概述

本文档详细说明了AI竞赛平台的鉴权系统实现，包括用户认证、授权、会话管理等核心功能。

## 系统架构

### 技术栈
- **后端框架**: Nuxt.js 4.0 (服务端渲染)
- **数据库**: MongoDB (使用Prisma ORM)
- **认证方式**: JWT (JSON Web Token)
- **密码加密**: bcryptjs
- **输入验证**: Zod
- **邮件服务**: Nodemailer

### 架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端页面      │    │   API路由       │    │   数据库        │
│                 │    │                 │    │                 │
│ • 登录/注册页   │◄──►│ • /api/auth/*   │◄──►│ • User模型      │
│ • 受保护页面    │    │ • 中间件验证    │    │ • 会话管理      │
│ • 权限控制      │    │ • 权限检查      │    │ • 令牌存储      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   JWT Token     │
                    │   Cookie存储    │
                    └─────────────────┘
```

## 核心组件详解

### 1. 用户模型 (User Model)

**文件位置**: [`webapp/prisma/schema.prisma`](webapp/prisma/schema.prisma:13-44)

```prisma
model User {
  id                          String          @id @default(auto()) @map("_id") @db.ObjectId
  username                    String          @unique
  email                       String          @unique
  passwordHash                String          // bcrypt哈希
  role                        String          @default("user")
  status                      UserStatus      @default(PENDING)

  // 邮箱验证
  emailVerifiedAt             DateTime?
  emailVerificationToken      String?
  emailVerificationExpires    DateTime?

  // 密码重置
  passwordResetToken          String?
  passwordResetTokenExpiresAt DateTime?

  // ... 其他字段
}

enum UserStatus {
  PENDING // 待验证
  ACTIVE  // 正常
  BANNED  // 封禁
}
```

**关键特性**:
- 用户名和邮箱唯一性约束
- 密码单向哈希存储
- 邮箱验证机制
- 用户状态管理
- 密码重置功能

### 2. JWT Token 管理

**文件位置**: [`webapp/server/utils/jwt.ts`](webapp/server/utils/jwt.ts)

#### Token 生成
```typescript
export function generateToken(user: User): string {
  const payload: JwtPayload = {
    userId: user.id,
    username: user.username,
    email: user.email
  }

  return jwt.sign(payload, config.jwtSecret, {
    expiresIn: '7d',
    issuer: 'aigame-platform'
  })
}
```

#### Token 验证
```typescript
export function verifyToken(token: string): JwtPayload | null {
  try {
    return jwt.verify(token, config.jwtSecret, {
      issuer: 'aigame-platform'
    }) as JwtPayload
  } catch (error) {
    return null
  }
}
```

**配置参数**:
- **有效期**: 7天
- **发行者**: aigame-platform
- **算法**: HS256 (默认)
- **存储方式**: HttpOnly Cookie

### 3. 密码安全

**文件位置**: [`webapp/server/utils/auth.ts`](webapp/server/utils/auth.ts:5-12)

#### 密码哈希
```typescript
export async function hashPassword(password: string): Promise<string> {
  const saltRounds = 12  // 高安全级别
  return await bcrypt.hash(password, saltRounds)
}
```

#### 密码验证
```typescript
export async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return await bcrypt.compare(password, hash)
}
```

**安全特性**:
- 使用bcrypt算法
- Salt rounds = 12 (2^12 = 4096次迭代)
- 每个密码使用唯一salt
- 防止彩虹表攻击

### 4. 中间件系统

#### 通用鉴权中间件
**文件位置**: [`webapp/middleware/auth.ts`](webapp/middleware/auth.ts)

```typescript
export default defineNuxtRouteMiddleware((to, from) => {
  const { isLoggedIn, user } = useCustomAuth()

  // 检查登录状态
  if (!isLoggedIn.value) {
    return navigateTo({
      path: '/login',
      query: { redirect: to.fullPath }
    })
  }

  // 检查角色权限
  const requiredRole = to.meta.requiredRole
  if (requiredRole && user.value?.role !== requiredRole) {
    return navigateTo({
      path: '/',
      query: {
        error: 'access_denied',
        message: '您没有权限访问此页面'
      }
    })
  }
})
```

#### 管理员权限中间件
**文件位置**: [`webapp/middleware/admin.ts`](webapp/middleware/admin.ts)

```typescript
export default defineNuxtRouteMiddleware((to) => {
  const { isLoggedIn, user } = useCustomAuth()

  if (!isLoggedIn.value) {
    return navigateTo('/login')
  }

  if (user.value?.role !== 'admin') {
    return navigateTo('/', {
      query: {
        error: 'access_denied',
        message: '您没有权限访问此页面'
      }
    })
  }
})
```

### 5. 认证API端点

#### 用户登录
**文件位置**: [`webapp/server/api/auth/login.post.ts`](webapp/server/api/auth/login.post.ts)

**流程**:
1. 输入验证 (Zod schema)
2. 用户查找 (支持邮箱/用户名)
3. 密码验证
4. 用户状态检查
5. JWT生成
6. Cookie设置
7. 返回用户信息

**输入验证**:
```typescript
const loginSchema = z.object({
  identifier: z.string().min(1), // 邮箱或用户名
  password: z.string().min(1)
})
```

**Cookie配置**:
```typescript
setCookie(event, 'auth-token', token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  maxAge: 60 * 60 * 24 * 7 // 7天
})
```

#### 用户注册
**文件位置**: [`webapp/server/api/auth/register.post.ts`](webapp/server/api/auth/register.post.ts)

**流程**:
1. 输入验证
2. 重复性检查 (邮箱、用户名、学号)
3. 密码哈希
4. 验证令牌生成
5. 用户创建
6. 验证邮件发送
7. 自动登录

**输入验证**:
```typescript
const registerSchema = z.object({
  username: z.string().min(3).max(50).regex(/^[a-zA-Z0-9_-]+$/),
  email: z.string().email(),
  password: z.string().min(6).max(100),
  phoneNumber: z.string().regex(/^1[3-9]\d{9}$/).optional(),
  studentId: z.string().min(6).max(20).optional(),
  realName: z.string().min(2).max(50).optional(),
  education: z.enum(['BACHELOR', 'MASTER', 'DOCTORATE']).optional()
})
```

#### 获取当前用户
**文件位置**: [`webapp/server/api/auth/me.get.ts`](webapp/server/api/auth/me.get.ts)

**流程**:
1. 从Cookie获取Token
2. Token验证
3. 用户查找
4. 头像URL处理
5. 返回安全用户信息

#### 用户登出
**文件位置**: [`webapp/server/api/auth/logout.post.ts`](webapp/server/api/auth/logout.post.ts)

**流程**:
1. 清除auth-token Cookie
2. 返回成功消息

**注意**: JWT本身无法撤销，只能通过清除Cookie实现客户端登出

### 6. 密码重置功能

#### 忘记密码
**文件位置**: [`webapp/server/api/auth/forgot-password.post.ts`](webapp/server/api/auth/forgot-password.post.ts)

**流程**:
1. 邮箱验证
2. 用户查找和状态检查
3. 重置令牌生成 (32字节随机)
4. 令牌存储 (1小时有效期)
5. 重置邮件发送

#### 密码重置
**文件位置**: [`webapp/server/api/auth/reset-password.post.ts`](webapp/server/api/auth/reset-password.post.ts)

**流程**:
1. 输入验证 (邮箱、令牌、新密码)
2. 用户查找和状态检查
3. 令牌验证和过期检查
4. 新密码哈希
5. 数据库更新
6. 令牌清除

### 7. 邮件验证系统

**文件位置**: [`webapp/server/utils/email.ts`](webapp/server/utils/email.ts)

#### 验证邮件发送
```typescript
export async function sendEmailVerification(
  email: string,
  token: string,
  username: string
): Promise<boolean> {
  const verificationUrl = `${baseUrl}/auth/verify-email?token=${token}&email=${email}`
  // 发送HTML邮件
}
```

#### 邮件模板
- 响应式HTML设计
- 品牌一致性
- 安全提示信息
- 操作按钮

### 8. 前端鉴权组合函数

**文件位置**: [`webapp/composables/useAuth.ts`](webapp/composables/useAuth.ts)

#### 状态管理
```typescript
export const useCustomAuth = () => {
  const user = useState<SafeUser | null>('auth.user', () => null)
  const isLoading = useState<boolean>('auth.loading', () => false)
  const isLoggedIn = computed(() => !!user.value)

  // 方法: login, register, logout, fetchUser
}
```

#### 主要方法

**登录**:
```typescript
const login = async (identifier: string, password: string) => {
  const data = await $fetch('/api/auth/login', {
    method: 'POST',
    body: { identifier, password }
  })

  if (data.success) {
    user.value = data.user
    await navigateTo('/')
  }
}
```

**注册**:
```typescript
const register = async (username, email, password, ...) => {
  const data = await $fetch('/api/auth/register', {
    method: 'POST',
    body: { username, email, password, ... }
  })

  if (data.success) {
    user.value = data.user
  }
}
```

## 权限控制系统

### 角色定义
- **user**: 普通用户，可以参与竞赛
- **admin**: 管理员，拥有所有权限

### 权限检查流程
1. **路由级别**: 通过中间件检查
2. **组件级别**: 通过`v-if`条件渲染
3. **API级别**: 通过服务端验证

### 页面保护示例
```typescript
// 页面元数据
definePageMeta({
  middleware: 'auth', // 需要登录
  requiredRole: 'admin' // 需要管理员权限
})
```

## 安全配置

### JWT配置
**文件位置**: [`webapp/nuxt.config.ts`](webapp/nuxt.config.ts:42)

```typescript
runtimeConfig: {
  jwtSecret: process.env.JWT_SECRET || 'your-super-secret-jwt-key',
  // 其他配置...
}
```

### 环境变量
**文件位置**: [`webapp/.env.example`](webapp/.env.example)

```env
# JWT密钥 - 生产环境必须修改
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# 数据库连接
MONGODB_URI=mongodb://root:password@mongo:27017/aigame

# SMTP邮件配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-smtp-password
```

## API接口文档

### 认证相关接口

#### POST /api/auth/login
**描述**: 用户登录
**请求体**:
```json
{
  "identifier": "user@example.com", // 邮箱或用户名
  "password": "password123"
}
```
**响应**:
```json
{
  "success": true,
  "user": {
    "id": "...",
    "username": "...",
    "email": "...",
    "role": "user",
    "status": "ACTIVE"
  },
  "token": "eyJ..."
}
```

#### POST /api/auth/register
**描述**: 用户注册
**请求体**:
```json
{
  "username": "newuser",
  "email": "user@example.com",
  "password": "password123",
  "phoneNumber": "13800138000", // 可选
  "studentId": "2021001", // 可选
  "realName": "张三", // 可选
  "education": "BACHELOR" // 可选
}
```

#### GET /api/auth/me
**描述**: 获取当前用户信息
**认证**: 需要JWT Token
**响应**:
```json
{
  "success": true,
  "user": {
    "id": "...",
    "username": "...",
    "email": "...",
    // 用户详细信息
  }
}
```

#### POST /api/auth/logout
**描述**: 用户登出
**响应**:
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

## 错误处理

### 错误类型
1. **验证错误** (400): 输入格式不正确
2. **认证错误** (401): 未登录或Token无效
3. **授权错误** (403): 权限不足
4. **冲突错误** (409): 资源冲突 (如邮箱已存在)
5. **服务器错误** (500): 内部错误

### 错误响应格式
```json
{
  "statusCode": 400,
  "statusMessage": "Validation failed",
  "data": [
    {
      "path": ["email"],
      "message": "Invalid email format"
    }
  ]
}
```

## 最佳实践

### 开发建议
1. **环境变量**: 所有敏感配置使用环境变量
2. **输入验证**: 前后端都要进行输入验证
3. **错误处理**: 不要在错误信息中泄露敏感信息
4. **日志记录**: 记录安全相关的操作日志
5. **测试**: 编写安全相关的单元测试和集成测试

### 部署建议
1. **HTTPS**: 生产环境必须使用HTTPS
2. **JWT密钥**: 使用强随机密钥
3. **数据库安全**: 配置数据库访问权限
4. **监控**: 设置安全监控和告警
5. **备份**: 定期备份用户数据

## 常见问题

### Q: JWT Token如何撤销？
A: 当前实现中JWT无法主动撤销，只能通过以下方式：
- 客户端删除Cookie
- 等待Token过期
- 考虑实现JWT黑名单机制

### Q: 如何处理并发登录？
A: 当前系统允许多设备同时登录，如需限制：
- 在数据库中记录活跃会话
- 登录时清除其他会话
- 实现会话管理界面

### Q: 密码强度如何控制？
A: 当前要求最小6位，建议：
- 提高到8位以上
- 添加复杂度要求
- 使用密码强度检查库

### Q: 如何防止暴力破解？
A: 建议添加：
- IP级别的速率限制
- 账户锁定机制
- 验证码验证
- 异常登录检测

---

*本文档会随着系统更新而持续维护，请关注最新版本。*